# Synapse Configuration File
# This file contains all configuration options for the Synapse reverse proxy
#
# Environment Variable Overrides:
# All configuration options can be overridden using environment variables with the AX_ prefix.
# For example: AX_SERVER_UPSTREAM=http://localhost:8080
#
# Available environment variables:
# - AX_SERVER_HTTP_ADDR, AX_SERVER_TLS_ADDR, AX_SERVER_UPSTREAM
# - AX_SERVER_HTTP_BIND, AX_SERVER_TLS_BIND (comma-separated)
# - AX_SERVER_HEALTH_CHECK_ENABLED, AX_SERVER_HEALTH_CHECK_ENDPOINT, AX_SERVER_HEALTH_CHECK_PORT
# - AX_SERVER_HEALTH_CHECK_METHODS, AX_SERVER_HEALTH_CHECK_ALLOWED_CIDRS (comma-separated)
# - AX_TLS_MODE, AX_TLS_ONLY, AX_TLS_CERT_PATH, AX_TLS_KEY_PATH
# - AX_ACME_DOMAINS, AX_ACME_CONTACTS (comma-separated)
# - AX_ACME_USE_PROD, AX_ACME_DIRECTORY, AX_ACME_ACCEPT_TOS, AX_ACME_CA_ROOT
# - AX_REDIS_URL, AX_REDIS_PREFIX
# - AX_NETWORK_IFACE, AX_NETWORK_IFACES (comma-separated), AX_NETWORK_DISABLE_XDP, AX_NETWORK_IP_VERSION
# - AX_ARXIGNIS_API_KEY, AX_ARXIGNIS_BASE_URL, AX_ARXIGNIS_LOG_SENDING_ENABLED, AX_ARXIGNIS_INCLUDE_RESPONSE_BODY, AX_ARXIGNIS_MAX_BODY_SIZE
# - AX_DOMAINS_WHITELIST (comma-separated)
# - AX_LOGGING_LEVEL
# - AX_CAPTCHA_SITE_KEY, AX_CAPTCHA_SECRET_KEY, AX_CAPTCHA_JWT_SECRET
# - AX_CAPTCHA_PROVIDER, AX_CAPTCHA_TOKEN_TTL, AX_CAPTCHA_CACHE_TTL

# Redis Configuration
redis:
  # Redis connection URL for ACME cache storage
  url: "redis://127.0.0.1/0"

  # Namespace prefix for Redis ACME cache entries
  prefix: "ax:synapse"

  # Redis SSL/TLS configuration (optional)
  # ssl:
  #   # Path to CA certificate file (PEM format)
  #   ca_cert_path: "/path/to/ca.crt"
  #   # Path to client certificate file (PEM format, optional, for mutual TLS)
  #   client_cert_path: "/path/to/client.crt"
  #   # Path to client private key file (PEM format, optional, for mutual TLS)
  #   client_key_path: "/path/to/client.key"
  #   # Skip certificate verification (for testing with self-signed certs)
  #   insecure: false

# Network Configuration
network:
  # The network interface to attach the XDP program to
  iface: "eth0"

  # Additional network interfaces for XDP attach (overrides iface if set)
  ifaces: []

  # Disable XDP packet filtering (run without BPF/XDP)
  disable_xdp: false

  # IP version support mode: "ipv4", "ipv6", or "both" (default: "both")
  # Note: XDP requires IPv6 to be enabled at kernel level for attachment,
  # even in IPv4-only mode. This is a kernel limitation. When set to "ipv4",
  # the system will attempt to enable IPv6 on the interface just for XDP
  # attachment (not system-wide), allowing IPv4-only operation elsewhere.
  # Options:
  #   - "ipv4": Process IPv4 packets only (IPv6 still required for XDP attachment)
  #   - "ipv6": Process IPv6 packets only
  #   - "both": Process both IPv4 and IPv6 packets (default)
  ip_version: "both"

# Gen0Sec Configuration
arxignis:
  # API key for Gen0Sec service
  api_key: ""

  # Base URL for Gen0Sec API
  base_url: "https://api.gen0sec.com/v1"

  # Enable sending access logs to arxignis server
  log_sending_enabled: true

  # Include response body in access logs
  include_response_body: true

  # Maximum size for request/response bodies in access logs (bytes) - Don't override in Basic plan that's the maximum allowed by the plan.
  max_body_size: 1048576

  # Captcha Configuration
  captcha:
    # Captcha site key for security verification
    site_key: null

    # Captcha secret key for security verification
    secret_key: null

    # JWT secret key for captcha token signing - openssl rand -base64 48
    jwt_secret: null

    # Captcha provider: hcaptcha, recaptcha, turnstile
    provider: "hcaptcha"

    # Captcha token TTL in seconds
    token_ttl: 7200

    # Captcha validation cache TTL in seconds
    cache_ttl: 300

# Content Scanning
content_scanning:
  # Enable or disable content scanning
  enabled: false

  # ClamAV server address
  clamav_server: "localhost:3310"

  # Maximum file size to scan in bytes (10MB)
  max_file_size: 10485760

  # Content types to scan (empty means scan all)
  scan_content_types:
    - "text/html"
    - "application/x-www-form-urlencoded"
    - "multipart/form-data"
    - "application/json"
    - "text/plain"

  # Skip scanning for specific file extensions
  skip_extensions: []

  # Wirefilter expression to determine when to scan content
  # Default: scan POST and PUT requests
  # Examples:
  #   - "http.request.method eq \"POST\" or http.request.method eq \"PUT\""
  #   - "http.request.method eq \"POST\" and http.request.path contains \"/upload\""
  #   - "http.request.content_type contains \"multipart/form-data\""
  scan_expression: "http.request.method eq \"POST\" or http.request.method eq \"PUT\""

# Logging Configuration
logging:
  # Log level: error, warn, info, debug, trace
  level: "info"

# BPF Statistics Configuration
bpf_stats:
  # Enable BPF statistics collection
  enabled: true

  # Log statistics every N seconds
  log_interval_secs: 60

  # Enable separate dropped IP events logging
  enable_dropped_ip_events: true

  # Log dropped IP events every N seconds (separate from general stats)
  dropped_ip_events_interval_secs: 30

# TCP Fingerprinting Configuration
tcp_fingerprint:
  # Enable TCP fingerprinting
  enabled: true

  # Log TCP fingerprinting statistics every N seconds
  log_interval_secs: 60

  # Enable separate TCP fingerprint events logging
  enable_fingerprint_events: true

  # Log TCP fingerprint events every N seconds (separate from general stats)
  fingerprint_events_interval_secs: 30

  # Minimum packet count to include in events (reduces noise from single-packet scans)
  min_packet_count: 3

  # Minimum connection duration in seconds to include in events
  min_connection_duration_secs: 1

# Daemon Configuration
daemon:
  # Enable daemon mode (run as background process)
  enabled: false

  # PID file path
  pid_file: "/var/run/synapse.pid"

  # Working directory for daemon
  working_directory: "/"

  # Stdout log file (application logs: info, debug, warn, error)
  stdout: "/var/log/synapse/access.log"

  # Stderr log file (panic messages and system errors)
  stderr: "/var/log/synapse/error.log"

  # User to run daemon as (optional, e.g., "nobody")
  user: null

  # Group to run daemon as (optional, e.g., "daemon")
  group: null

  # Change ownership of PID file to daemon user/group
  chown_pid_file: true

# Pingora Proxy System Configuration (old proxy system for upstreams)
# These settings enable the pingora-based proxy with multiple upstreams
pingora:
  # Pingora HTTP proxy bind address
  proxy_address_http: "0.0.0.0:80"

  # Optional: Pingora TLS proxy bind address
  proxy_address_tls: "0.0.0.0:443"

  # Mandatory if proxy_address_tls is set (cert files: {NAME}.crt, {NAME}.key)
  proxy_certificates: "/root/synapse/certs"

  # TLS suite grade (high, medium, unsafe)
  proxy_tls_grade: "medium"

  # Default fallback SSL certificate name (file stem without extension, e.g., "default" for default.crt)
  # If not specified, the first valid certificate will be used as default
  default_certificate: "default"

  # Path to upstreams configuration file
  upstreams_conf: "/root/synapse/upstreams.yaml"

  # HTTP API address for remote config updates
  config_address: "0.0.0.0:3000"

  # Enable remote config push capability
  config_api_enabled: false

  # Master key for API access
  master_key: "00000000-0000-0000-0000-000000000000"

  # Log level for old proxy system
  log_level: "info"

  # Health check method (HEAD, GET, POST)
  healthcheck_method: "HEAD"

  # Health check interval in seconds
  healthcheck_interval: 2

  # PROXY protocol configuration
  proxy_protocol:
    # Enable PROXY protocol parsing (required when behind a load balancer that sends PROXY headers)
    enabled: true
    # Timeout for reading PROXY protocol header in milliseconds
    timeout_ms: 1000


# ACME Configuration (Let's Encrypt certificate management)
acme:
  # Enable embedded ACME server for automatic certificate management
  enabled: false

  # Port for ACME server (for HTTP-01 challenges)
  # The server always binds to 127.0.0.1 (localhost only) for security
  port: 9180

  # Email address for Let's Encrypt account registration
  # Required for certificate issuance
  email: null

  # Storage type: "file" or "redis"
  # If not set, defaults to "file" or "redis" (if redis_url is set)
  storage_type: null

  # Storage path for certificates and ACME challenge files
  # Certificates will be stored in subdirectories per domain
  storage_path: "/var/lib/synapse/acme"

  # Use Let's Encrypt staging server (for testing)
  # Set to true for testing to avoid rate limits
  development: false

  # Redis URL for certificate storage (optional)
  # If not set, uses the global redis.url configuration
  # If set, overrides the global Redis URL for ACME storage
  redis_url: null

